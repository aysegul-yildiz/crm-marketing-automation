{% extends "base.html" %}
{% block content %}

<h2>Workflow Editor</h2>
<hr>

<h3>{{ workflow.name }} (ID: {{ workflow.id }})</h3>

<p style="color:#6b7280;">Here you will define workflow steps.</p>

<!-- ====================== ADD NEW STEP PANEL ====================== -->
<div style="
    border: 1px solid #d1d5db;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
">
    <h4 style="margin-top:0;">Add New Step</h4>

   <form action="{{ url_for('campaign.add_workflow_step') }}" 
        method="POST" 
        style="display:flex; flex-direction:column; gap:12px;"
        id="new-step-form">

        <input type="hidden" name="workflow_id" value="{{ workflow.id }}">

        <div>
            <label><strong>Step Order:</strong></label>
            <input type="number" name="step_order" min="1" required style="width:100%; margin-top:5px;">
        </div>

        <div>
            <label><strong>Action Type:</strong></label>
            <select name="action_type" id="action-type-select" required style="width:100%; margin-top:5px;">
                <option value="" disabled selected>Select Action Type</option>
                <option value="EMAIL">Email</option>
                <option value="SMS">SMS</option>
                <option value="DISCOUNT">Discount</option>
                <option value="DISCORD">Discord Post</option>
            </select>
        </div>

        <!-- ==== DISCOUNT FIELDS (hidden by default) ==== -->
        <div id="discount-fields" style="display:none; flex-direction:column; gap:10px;">

            <div>
                <label><strong>Discount %:</strong></label>
                <input type="number" min="1" max="100" id="discount-percent"
                    placeholder="Enter discount percentage"
                    style="width:100%; margin-top:5px;">
            </div>

            <div>
                <label><strong>Target Segmentation Group:</strong></label>
                <select id="discount-segmentation" style="width:100%; margin-top:5px;">
                    <option disabled selected>Select Segment</option>
                    {% for group in segmentation_groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- ============================================= -->

        <div>
            <label><strong>Action Payload (JSON or Text):</strong></label>
            <textarea name="action_payload" id="payload-field" rows="3"
                    placeholder="Payload content..." 
                    style="width:100%; margin-top:5px;"></textarea>
        </div>

        <div>
            <label><strong>Delay Minutes After Previous Step:</strong></label>
            <input type="number" name="delay_minutes_after_prev" min="0" value="0" style="width:100%; margin-top:5px;">
        </div>

        <button type="submit" class="btn-pill btn-primary-pill" style="margin-top:5px; width:100%;">
            Add Step
        </button>
    </form>

</div>

<!-- ====================== SCROLLABLE WORKFLOW STEPS ====================== -->
<div style="
    border: 1px solid #d1d5db;
    border-radius: 10px;
    padding: 15px;
    height: 500px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
">

    {% if steps %}
        {% for step in steps %}
        <div style="
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafafa;
        ">
            <strong style="font-size: 1.1rem;">
                Step {{ step.order }}: {{ step.action_type }}
            </strong>
            <br>
            <small style="color:#6b7280;">ID: {{ step.id }}</small>

            {% if step.action_payload %}
            <pre style="
                background:#f3f4f6;
                padding:10px;
                border-radius:6px;
                margin-top:10px;
                white-space:pre-wrap;
            ">{{ step.action_payload }}</pre>
            {% endif %}

            <p style="margin-top:8px; color:#6b7280;">
                Delay: {{ step.delay_minutes_after_prev }} minutes
            </p>
        </div>
        {% endfor %}
    {% else %}
        <p style="color:#6b7280;">No steps defined yet for this workflow.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const actionSelect = document.getElementById("action-type-select");
    const discountFields = document.getElementById("discount-fields");
    const payloadField = document.getElementById("payload-field");

    const discountPercent = document.getElementById("discount-percent");
    const discountSegment = document.getElementById("discount-segmentation");

    // Hide payload field when DISCOUNT selected
    function updatePayload() {
        const percent = discountPercent.value;
        const segment = discountSegment.value;

        if (!percent || !segment) return;

        payloadField.value = JSON.stringify({
            discount_percentage: Number(percent),
            segmentation_group_id: Number(segment)
        }, null, 2);
    }
    actionSelect.addEventListener("change", () => {
        const isDiscount = actionSelect.value === "DISCOUNT";
        if (isDiscount) {
            // Show discount fields
            discountFields.style.display = "flex";

            // Hide payload field
            payloadField.parentElement.style.display = "none";

            // Autofill payload internally
            payloadField.readOnly = true;
            updatePayload();
        } 
        else {
            // Hide discount fields
            discountFields.style.display = "none";

            // Show payload field again
            payloadField.parentElement.style.display = "block";

            payloadField.readOnly = false;
            payloadField.value = "";
        }
    });


    // Update payload when discount-specific inputs change
    discountPercent.addEventListener("input", updatePayload);
    discountSegment.addEventListener("change", updatePayload);
});
</script>


{% endblock %}
